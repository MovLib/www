# ----------------------------------------------------------------------------------------------------------------------
# This file is part of {@link https://github.com/MovLib MovLib}.
#
# Copyright © 2013-present {@link https://movlib.org/ MovLib}.
#
# MovLib is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public
# License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# MovLib is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY# without even the implied warranty
# of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License along with MovLib.
# If not, see {@link http://www.gnu.org/licenses/ gnu.org/licenses}.
# ----------------------------------------------------------------------------------------------------------------------

# ----------------------------------------------------------------------------------------------------------------------
# Default routes that are the same for all domains language specific domains. Please note that the default domain (the
# one without any language code) still has it's own configuration. This is because there is only a single page
# available, the language selection page. Other than that the default domain only delivers static content.
#
# AUTHOR: Richard Fussenegger <richard@fussenegger.info>
# COPYRIGHT: © 2013-present, MovLib
# LICENSE: http://www.gnu.org/licenses/agpl.html AGPL-3.0
# SINCE: 0.0.1-dev
# ----------------------------------------------------------------------------------------------------------------------

if ($movlib_invalid_request) {
  return 400;
}

# Invalid path, should be on RAM disk or similar for ultra fast look ups.
set $movlib_cache_path "/null/";

# Only GET requests are served from cache.
if ($request_method = GET) {
  set $movlib_cache_path "/cache/";
}

# Create absolute path to cache file.
set $movlib_cache $movlib_cache_path$movlib_language_code$uri;

location @home {
  set $movlib_presenter "Home";
  include sites/conf/fastcgi_params.conf;
}

location @php {
  include sites/conf/fastcgi_params.conf;
}

# The route /my is the same for all languages! "My MovLib"
location = /my {
  set $movlib_presenter "Home";
  include sites/conf/fastcgi_params.conf;
}

location = / {
  # If the user is logged in, redirect to the dashboard.
  if ($http_cookie ~ MOVSID) {
    return 302 /my;
  }
  # Otherwise file from cache or ask PHP.
  try_files $movlib_cache_path$movlib_language_code/home @home;
}

location / {
  include sites/conf/routes/protected.conf;
  include sites/conf/static_files.conf;
}
