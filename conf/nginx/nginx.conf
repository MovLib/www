# ----------------------------------------------------------------------------------------------------------------------
# This file is part of {@link https://github.com/MovLib MovLib}.
#
# Copyright © 2013-present {@link https://movlib.org/ MovLib}.
#
# MovLib is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public
# License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# MovLib is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY# without even the implied warranty
# of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License along with MovLib.
# If not, see {@link http://www.gnu.org/licenses/ gnu.org/licenses}.
# ----------------------------------------------------------------------------------------------------------------------

# ----------------------------------------------------------------------------------------------------------------------
# Main nginx configuration
#
# AUTHOR:     Richard Fussenegger <richard@fussenegger.info>
# COPYRIGHT:  © 2013 MovLib
# LICENSE:    http://www.gnu.org/licenses/agpl.html AGPL-3.0
# LINK:       https://movlib.org/
# SINCE:      0.0.1-dev
# ----------------------------------------------------------------------------------------------------------------------

error_log                         /var/log/nginx/error.log debug;
pcre_jit                          on;
timer_resolution                  100ms;
worker_processes                  2;
worker_cpu_affinity               0001 0010;
worker_priority                   15;
worker_rlimit_core                0;
worker_rlimit_nofile              262144;

events {
  multi_accept                    on;
  use                             epoll;
  worker_connections              16384;
}

http {
  access_log                      off;
  charset                         utf-8;
  charset_types                   application/javascript application/json application/xml image/svg+xml text/css text/plain;
  client_body_timeout             2s;
  client_header_timeout           2s;
  client_max_body_size            16m;
  default_type                    application/octet-stream;
  ignore_invalid_headers          on;
  index                           main.php;
  keepalive_disable               none;
  keepalive_requests              50;
  keepalive_timeout               28s;
  max_ranges                      1;
  merge_slashes                   off;
  msie_padding                    off;
  output_buffers                  1 512;
  postpone_output                 1440;
  read_ahead                      512k;
  recursive_error_pages           on;
  reset_timedout_connection       on;
  root                            /var/www;
  send_timeout                    10s;
  sendfile                        on;
  sendfile_max_chunk              1M;
  server_name_in_redirect         off;
  server_names_hash_bucket_size   64;
  spdy_headers_comp               5;
  spdy_keepalive_timeout          128s;
  spdy_max_concurrent_streams     100;
  spdy_recv_timeout               2s;
  source_charset                  utf-8;
  tcp_nodelay                     on;
  tcp_nopush                      on;

  # GET and POST are always valid {@link https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods}.
  map $request_method $movlib_invalid_request {
    default 1;
    GET     0;
    HEAD    0;
    POST    0;
  }

  # Our API is of course RESTful and may accept more request methods.
  map $request_method $movlib_invalid_api_request {
    default 1;
    GET     0;
    HEAD    0;
    POST    0;
  }

  include                         conf/*.conf;
  include                         sites/*.conf;
}
